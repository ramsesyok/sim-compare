# シミュレーション向けシナリオデータ作成ツール

```markdown
## シミュレーションの内容 
- n個のオブジェクトが2チーム別れて動作する 
  - nは、1000程度を想定する。
- 全てのオブジェクトには移動開始時間と経路点(緯度経度)と経路間の速度(km/h)が事前に定められ、時間の経過と共に移動する。 
- 各チームには司令官役と斥候役と伝令役と攻撃役がおり、各チームに司令官は1人、斥候役・伝令役・攻撃役は複数人とする。
- 斥候役は敵チームの位置を確認したら、複数の伝令役を経由して味方の司令官役に伝える。 
- オブジェクトの移動・探知・通信を模擬するのみのシミュレーションとする。
  - 攻撃役は、爆発に関する設定を持つが、現時点ではオブジェクトの破壊は行わない。

### 斥候役(scout)
- 斥候役は、あらかじめ指定された経路に沿って最終点まで移動する。
- 斥候役は、あらかじめ指定された移動開始時間になるまで、最初の経路点から移動しない。
- 斥候役は、経路を移動中、相手チームのオブジェクトを発見したら、相手オブジェクトの位置を伝令役を介して司令官役に伝える。
- 斥候役は、あらかじめ指定された伝令役群にのみ情報を伝達できる。
- 斥候の探知範囲はdetect_range_m(m)とし、その範囲にいるオブジェクトを見つける事ができる。
- 通信可能距離はcomm_range_m(m)とし、その範囲の伝令役に情報が到達できる。
- 斥候役〜伝令役間の位置関係の都合で、通信が届く伝令役がだれもいない場合は、通信エラーをイベントログに出すが、計算は続行する。

###　伝令役(messenger)
- 伝令役は、あらかじめ指定された経路に沿って最終点まで移動する。
- 伝令役は、あらかじめ指定された移動開始時間になるまで、最初の経路点から移動しない。
- 伝令役の通信可能距離はcomm_range_m(m)とし、その範囲の伝令役・司令官役に情報が到達できる。
- 伝令役は、通信経路や通信順序は特に定めず、新しい情報が届いた時、その情報を再発信する。
  - すなわち、伝令役は、通信をホップすることだけを行い、特定の伝令役・司令官役に情報を届けることはしない。
- 斥候役〜伝令役間の位置関係の都合で、通信が届く伝令役がだれもいない場合は、通信エラーをイベントログに出すが、計算は続行する。
- 伝令役〜司令官役間の位置関係の都合で、通信が届く伝令役・司令官役がだれもいない場合は、通信エラーをイベントログに出すが、計算は続行する。

### 司令官(commander)
- 司令官役は、あらかじめ指定された位置にいるのみで移動しない。
- 司令官役は、伝令役から相手チームの位置情報を受信する。
  - 現時点で、司令官は情報受信をイベントログに出力するのみで、特に何もしない

### 攻撃役(attacker)
- 攻撃役は、あらかじめ指定された経路に沿って移動し、最終点まで移動する。
- 攻撃役は、あらかじめ指定された移動開始時間になるまで、最初の経路点から移動しない。
- 攻撃役は、最終地点に到達したらboom_range_m(m)の爆発を起こす。
　　- 現時点で、爆発をイベントログに残すのみで、他オブジェクトの破壊判定は実装しない。
　　
## 設定(scenario)
- あらかじめ設定される経路点は緯度(deg)・経度(deg).高度(m)で与えられる。
  - 緯度経度の測地系は、WGS84とする。
- あらかじめ設定される移動開始時間は、0:00からの相対時間とする
- 設定の情報は、jsonファイル形式で与えられる。

## 計算方法や実行条件について
- 全ての位置計算は、緯度経度をECEFに変換した3次元座標系(xyz空間)で行う。
- オブジェクト間の近傍探索にSparial Hashを用いる。
- 動き回る領域は日本海上を含む3000km四方とする。
- 計算上の時間間隔は1秒(シミュレーション時間の1秒ごとにオブジェクトが動く) 
- 計算範囲は0:00〜24:00の24時間分

## ログファイル
- 全てのオブジェクトの移動は、1つのタイムラインログとして出力する。
  - タイムラインログは、ndjson形式とする。
  - 1行のjsonに、シミュレーション時間と、全てのいオブジェクトの緯度経度高度をまとめる。
- 全てのオブジェクトで発生したイベントは、1つのイベントログとして出力する。
  - イベントログは、。ndjson形式とする。
  - 一行のjsonには、1オブジェクトで発生した1つのイベントを出力する。
 
```

このシミュレーションにあたり入力ファイルのJSONを以下のように想定している。

```json
{
  "performance":{
    "scout":{
      "comm_range_m": 5000,
      "detect_range_m": 10000
    },
    "messenger":{
      "comm_range_m": 8000
    },
    "attacker":{
      "bom_range_m": 1000
    }

  },
  "teams": [
    {
      "id": "A",
      "name": "Alpha Team",
      "objects": [
        {
          "id": "A_CMD",
          "role": "commander",
          "start_sec": 0,
          "waypoints": [
            {
              "lat_deg": 35.0,
              "lon_deg": 135.0,
              "alt_m": 0.0,
              "speeds_kph": 10
            }
          ]
        },
        {
          "id": "A_S01",
          "role": "scout",
          "start_sec": 60,
          "waypoints": [
            {
              "lat_deg": 35.1,
              "lon_deg": 135.0,
              "alt_m": 0.0,
              "speeds_kph": 15
            },
            {
              "lat_deg": 35.4,
              "lon_deg": 135.2,
              "alt_m": 0.0,
              "speeds_kph": 25
            }
          ],
          "relay_pool": [
            "A_M01",
            "A_M02",
            "A_M03"
          ]
        },
        {
          "id": "A_M01",
          "role": "messenger",
          "start_sec": 0,
          "waypoints": [
            {
              "lat_deg": 35.2,
              "lon_deg": 135.05,
              "alt_m": 0.0,
              "speeds_kph": 5
            },
            {
              "lat_deg": 35.25,
              "lon_deg": 135.10,
              "alt_m": 0.0,
              "speeds_kph": 10
            }
          ]
        },
        {
          "id": "A_M02",
          "role": "messenger",
          "start_sec": 0,
          "waypoints": [
            {
              "lat_deg": 35.2,
              "lon_deg": 135.05,
              "alt_m": 0.0,
              "speeds_kph": 5
            },
            {
              "lat_deg": 35.25,
              "lon_deg": 135.10,
              "alt_m": 0.0,
              "speeds_kph": 10
            }
          ]
        },
        {
          "id": "A_M03",
          "role": "messenger",
          "start_sec": 0,
          "waypoints": [
            {
              "lat_deg": 35.2,
              "lon_deg": 135.05,
              "alt_m": 0.0,
              "speeds_kph": 5
            },
            {
              "lat_deg": 35.25,
              "lon_deg": 135.10,
              "alt_m": 0.0,
              "speeds_kph": 10
            }
          ]
        }
      ]
    },
    {
      "id": "B",
      "name": "Bravo Team",
      "objects": [
        {
          "id": "B_CMD",
          "team": "B",
          "role": "commander",
          "start_sec": 0,
          "waypoints": [
            {
              "lat_deg": 36.0,
              "lon_deg": 134.7,
              "alt_m": 0.0,
              "speeds_kph": 5
            }
          ]
        }
      ]
    }
  ]
}
```

今回は、シミュレーションゲーム本体ではなく、設定(scenario)情報をもつJSONファイルを作るためのツールを作成してください。

## ツールの機能
- 各チームの司令官の位置を緯度経度高度で指定できる。
- 斥候役・伝令役・攻撃役の経路の最初の点は、自チームの司令官役から半径spawn_range_m(m)の範囲とする。
- 斥候役・伝令役・攻撃役の経路は、最初の点から相手チームの司令官役の位置を最終点とし、ランダムウォークで移動する。
- 斥候役・伝令役・攻撃役の経路は、最低5点設けること。
- 斥候役・伝令役・攻撃役の経路間の速度は、max_speed_kph,min_speed_kphの間でランダムとする。
- 斥候役・伝令役・攻撃役の移動開始時間は、ランダムで設定する。
- 伝令役の経路は生成された経路を、ユーザーが手動で修正することができる。
- 斥候役・伝令役・攻撃役の経路は、ランダム生成後，気に入らなければ再生できる。
  - この時、ユーザーが手動で修正した伝令役の経路も消えてしまって良い。
 
## ツールの条件
- ツールは、インターネットから切断されたオフラインで利用できること。
- 地図は、https://www.naturalearthdata.com/http//www.naturalearthdata.com/download/110m/physical/ne_110m_coastline.zip を用いる。





#### 初期位置メモ

add_entry("Cmd A Lat:", "A_lat", 33.593285592006765) # 福岡タワー
add_entry("Cmd A Lon:", "A_lon", 130.35150899543166)
add_entry("Cmd B Lat:", "B_lat", 31.23971183320547) # 上海タワー
add_entry("Cmd B Lon:", "B_lon", 121.49974993544004)